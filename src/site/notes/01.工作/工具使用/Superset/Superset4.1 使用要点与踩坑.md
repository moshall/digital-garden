---
{"dg-publish":true,"permalink":"/01.å·¥ä½œ/å·¥å…·ä½¿ç”¨/Superset/Superset4.1 ä½¿ç”¨è¦ç‚¹ä¸è¸©å‘/","title":"Superset4.1 ä½¿ç”¨è¦ç‚¹ä¸è¸©å‘"}
---


## 1.æ•°æ®é›†

#####  æ•°æ®é›†å‘½å

Superset4.1<u>ä¸æ”¯æŒä¸­æ–‡å‘½åçš„æ•°æ®é›†</u>ï¼Œä¸€æ—¦æ•°æ®é›†å‘½åä¸ºä¸­æ–‡ï¼Œå°±å†ä¹Ÿæ‰“å¼€ä¸å¼€ï¼Œä¹Ÿæ— æ³•ç¼–è¾‘å’Œç®¡ç†äº†ï¼Œåªèƒ½åˆ é™¤ã€‚
å¦‚æœæ•°æ®é›†åç§°åŒ…å«è‹±æ–‡å¤§å†™ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šæœ‰ä¿å­˜ä¸äº†çš„é—®é¢˜ã€‚
ä½†æ˜¯å¯ä»¥åœ¨æ•°æ®é›†çš„è®¾ç½®ä¸­ï¼Œæè¿°æ ç¼–å†™è¿™ä¸ªæ•°æ®é›†çš„ç”¨é€”ï¼Œè¿™ä¸ªåœ°æ–¹å¯ä»¥ç”¨ä¸­æ–‡

#####  æ•°æ®é›†ä¿å­˜

åœ¨1.5ç‰ˆæœ¬supersetä¸­ï¼Œæ— è®ºä»»ä½•æ ¼å¼çš„SQLåªè¦èƒ½æŸ¥å‡ºæ•°æ®ï¼Œå‡å¯ä¿å­˜ä¸ºæ•°æ®é›†
åœ¨4.1ç‰ˆæœ¬ä¸­ï¼Œéœ€è¦å…ˆå°†æ•°æ®é›†è¿›è¡Œæ ¼å¼åŒ–å¤„ç†ï¼Œå†ä¿å­˜ä¸ºæ•°æ®é›†ï¼Œå¦åˆ™ä¼šå‡ºç°æŠ¥é”™

æ“ä½œæ­¥éª¤ï¼š
ç¬¬ä¸€æ­¥ï¼Œæ‰§è¡ŒæŸ¥è¯¢
![image.png](https://chengdu-obsidian-milkkey.oss-cn-chengdu.aliyuncs.com/img/20250514131849437.png?cd-oss-obs)

ç¬¬äºŒæ­¥ï¼ŒFormatSQL
![image.png](https://chengdu-obsidian-milkkey.oss-cn-chengdu.aliyuncs.com/img/20250514131934290.png?cd-oss-obs)

ç¬¬ä¸‰æ­¥ï¼Œä¿å­˜æ•°æ®é›†
![image.png](https://chengdu-obsidian-milkkey.oss-cn-chengdu.aliyuncs.com/img/20250514132007136.png?cd-oss-obs)


## 2.å›¾è¡¨ - æ—¶é—´åºåˆ—åŠŸèƒ½ç®€è¿°


Apache Superset 4.1 æŠŠâ€œæ—¶é—´åºåˆ—â€åšæˆäº†ä¸€ä¸ªå®Œæ•´çš„åˆ†æé“¾æ¡ï¼šåœ¨å¯è§†åŒ–å±‚é¢æ–°å¢ **Big Number with Time Period Comparison** ä¸ **Table with Time Comparison** ä¸¤ä¸ªæ–°å›¾è¡¨ï¼›åœ¨æŸ¥è¯¢å±‚é¢è¡¥è¶³â€œå½“å‰å‘¨/æœˆ/å¹´â€å¿«æ·æ—¶é—´è¿‡æ»¤å™¨å’Œ `{{ get_time_filter() }}` Jinja å®ï¼›åœ¨ä½“éªŒå±‚é¢è¿˜ä¿®å¤äº† Time Comparison æŸ¥è¯¢çš„è‹¥å¹² bugï¼Œå¹¶å…è®¸ä¸º Dashboards é…ç½®è‡ªå®šä¹‰åˆ·æ–°é¢‘ç‡ã€‚([Preset][1], [Fossies][2], [Fossies][3])
ä¸‹é¢é€šè¿‡ä¸€ä¸ªâ€œæœ€è¿‘ 30 å¤©é”€å”®é¢ VS å»å¹´åŒæœŸâ€çš„å®Œæ•´ç¤ºä¾‹ï¼ŒæŠŠ 4.1 é‡Œçš„æ—¶é—´åºåˆ—èƒ½åŠ›ä¸²èµ·æ¥æ¼”ç¤ºã€‚

---

#### å¸¸è§æ—¶é—´åºåˆ—å›¾è¡¨åŠå…¶å®šä½

| å›¾è¡¨                                         | å…¸å‹ç”¨é€”       | 4.1 è¡¥å¼ºç‚¹                                  |
| ------------------------------------------ | ---------- | ---------------------------------------- |
| **Time-series Line / Area / Bar**          | é€šç”¨è¶‹åŠ¿ã€åˆ†ç»„å¯¹æ¯”  | æ”¯æŒâ€œå½“å‰â€æ—¥æœŸå¿«æ·è¿‡æ»¤ï¼›Time Comparison ä¿®å¤          |
| **Big Number with Time Period Comparison** | KPI + åŒ/ç¯æ¯” | æ–°å¢å›¾è¡¨ï¼ˆéœ€æ‰“å¼€è¯•éªŒæ€§æ’ä»¶ï¼‰([Preset][1], [GitHub][4]) |
| **Table with Time Comparison**             | æ˜ç»†è¡¨ + å¯¹æ¯”åˆ—  | æ–°å¢å›¾è¡¨ï¼ˆåŒä¸Šï¼‰([Fossies][2], [GitHub][4])      |
| **Mixed Time-series**                      | å¤šåº¦é‡ / åŒè½´   | å»¶ç»­ 4.0 ç‰ˆèƒ½åŠ›                               |

Superset è¿˜ä¿ç•™äº† Horizonã€Calendar Heatmap ç­‰é«˜çº§æ—¶åºå¯è§†åŒ–ï¼Œå…¨éƒ¨åˆ—åœ¨å®˜æ–¹æ–‡æ¡£ä¸­([Preset][5])ã€‚

---

#### ç¤ºä¾‹ï¼šå¯¹æ¯”æœ€è¿‘ 30 å¤©ä¸å»å¹´åŒæœŸçš„é”€å”®é¢

> **æ•°æ®å‡è®¾**ï¼šè¡¨ `ecommerce_sales`ï¼Œå­—æ®µ
> `order_date TIMESTAMP`ã€`revenue DECIMAL`ã€‚

##### 1 å‡†å¤‡æ•°æ®é›†

1. åœ¨ **Data â†’ Datasets** é€‰æ‹©æˆ–åˆ›å»º `ecommerce_sales`ã€‚
2. ç¡®è®¤ `order_date` åˆ—è¢«æ ‡è®°ä¸º *temporal* ç±»å‹ï¼›åªæœ‰è¿™æ ·å®ƒæ‰èƒ½å‡ºç°åœ¨ *Time column* ä¸‹æ‹‰æ¡†é‡Œ([Preset][5])ã€‚

---

##### 2 ç»˜åˆ¶ Time-series Line Chartï¼ˆå»å¹´åŒæœŸå¯¹æ¯”ï¼‰

1. **Charts â†’ + Create Chart**ï¼Œé€‰æ•°æ®é›† â†’ é€‰ *Time-series Line Chart*ã€‚
2. **Time** é¢æ¿

   * Time rangeï¼š*Last 30 days*
   * Time grainï¼š*day*
3. **Query** é¢æ¿

   * Metricsï¼š `SUM(revenue)`
   * **Time Comparison**ï¼š`1 year ago` â†’ Superset ä¼šç”Ÿæˆä¸€æ¡è™šçº¿è¡¨ç¤ºå»å¹´åŒæœŸ([Preset][5])ã€‚
4. **Advanced Analytics**ï¼ˆå¯é€‰ï¼‰

   * Rolling windowï¼š7 â†’ å¹³æ»‘çŸ­æœŸæ³¢åŠ¨ï¼Œåš 7 æ—¥ç§»åŠ¨å¹³å‡([Preset][5])ã€‚
5. ç‚¹å‡» **Run** â†’ **Save**ï¼Œå³å¯åœ¨ä»ªè¡¨ç›˜é‡Œçœ‹åˆ°ä¸¤æ¡æ—¶é—´åºåˆ—ã€‚

---

##### 3 ç»˜åˆ¶ Big Number with Time Period Comparison

> è¯¥å›¾è¡¨åœ¨ 4.1 å¤„äºè¯•éªŒé˜¶æ®µï¼Œå…ˆåœ¨ `superset_config.py` æ‰“å¼€
>
> ```python
> FEATURE_FLAGS = {"CHART_PLUGINS_EXPERIMENTAL": True}
> ```
>
> ä¹Ÿå¯ç”¨ç¯å¢ƒå˜é‡ `SUPERSET_FEATURE_CHART_PLUGINS_EXPERIMENTAL=True`([GitHub][4])

1. æ–°å»ºå›¾è¡¨ â†’ é€‰ *Big Number with Time Period Comparison*ã€‚
2. Settings

   * Metricï¼š`SUM(revenue)`
   * Time rangeï¼š*Last 30 days*
   * **Comparison period**ï¼š*Previous period*ï¼ˆåŒä¸Šä¸€æ®µ 30 å¤©ï¼‰ã€‚
3. è¿è¡Œåï¼Œå¡ç‰‡ä¼šæ˜¾ç¤ºï¼š

   * ä¸»æŒ‡æ ‡ï¼ˆæœ€è¿‘ 30 å¤©é”€å”®æ€»é¢ï¼‰ï¼›
   * å¯¹æ¯”å€¼ï¼ˆå‰ 30 å¤©ï¼‰ï¼›
   * ç»å¯¹å¢å‡ & ç™¾åˆ†æ¯”å¢å‡([Preset][1], [Preset æ–‡æ¡£][6])ã€‚

> æƒ³çœ‹â€œå»å¹´åŒæœŸâ€å°±æŠŠ Comparison period æ”¹æˆ *1 year ago*ã€‚

---

##### 4 ä½¿ç”¨ Table with Time Comparison

1. æ–°å»ºå›¾è¡¨ â†’ é€‰ *Table with Time Comparison*ã€‚
2. Columns é‡Œæ”¾ `order_date`ï¼ˆæŒ‰æ—¥ç²’åº¦ï¼‰å’Œ `SUM(revenue)`ã€‚
3. Comparison period åŒæ ·é€‰ *1 year ago*ã€‚
4. è¿è¡Œåï¼Œè¡¨æ ¼ä¼šè‡ªåŠ¨æ·»åŠ ä¸‰åˆ—ï¼šå¯¹æ¯”å€¼ã€å·®å€¼ã€ç™¾åˆ†æ¯”å·®å€¼([Fossies][2])ã€‚

---

##### 5 å–„ç”¨æ—¶é—´è¿‡æ»¤ä¸ Jinja å®

* â€œå½“å‰å‘¨/æœˆ/å¹´â€å¿«æ·é¡¹å¯ä¸€é”®æŸ¥çœ‹æ»šåŠ¨çª—å£æ•°æ®([Preset][1])ã€‚
* å¯¹å¤æ‚ SQLï¼Œå¯åœ¨æŸ¥è¯¢é‡Œå†™ `WHERE {{ get_time_filter('order_date') }}`ï¼Œè®© Dashboard çš„æ—¶é—´ç­›é€‰è‡ªåŠ¨æ³¨å…¥([Preset][1])ã€‚

---

#### å¸¸è§é—®é¢˜ä¸æŠ€å·§

| åœºæ™¯      | è§£å†³æ–¹æ¡ˆ                                                                           |
| ------- | ------------------------------------------------------------------------------ |
| æ¯”è¾ƒåˆ—ä¸æ˜¾ç¤º  | ç¡®è®¤ **CHART\_PLUGINS\_EXPERIMENTAL** å·²å¼€å¯ï¼Œå¹¶åœ¨ *Query â†’ Time Comparison* é€‰ä¸­å‘¨æœŸã€‚     |
| æ•°æ®ç‚¹å¤ªå¤š   | è°ƒä½ *Time grain*ï¼ˆå¦‚ day â†’ weekï¼‰æˆ–å¯ç”¨ 7/30 æ—¥ rolling å¹³æ»‘ã€‚                            |
| å¤šç³»åˆ—é¢œè‰²æ··ä¹± | åœ¨ *Customize â†’ Color Scheme* é‡Œé€‰æ‹©è°ƒè‰²æ¿ï¼Œæˆ–ç»™å…³é”®ç³»åˆ—å›ºå®šé¢œè‰²ã€‚                                |
| éœ€è¦ç½®ä¿¡åŒºé—´  | åœ¨ Line Chart ä¸­å‡†å¤‡ `metric__yhat_lower/upper` åˆ—ï¼ŒSuperset ä¼šè‡ªåŠ¨ç”»å‡ºå¸¦çŠ¶åŒºé—´([GitHub][7])ã€‚ |

---

#### å°ç»“

Superset 4.1 çš„â€œæ—¶é—´åºåˆ—â€ä¸ä»…æ–°å¢äº† **Big Number** ä¸ **Table** ä¸¤æ¬¾å¯¹æ¯”å‹å›¾è¡¨ï¼Œè¿˜æŠŠæ—¶é—´æ¯”è¾ƒã€å¿«æ·æ—¶é—´è¿‡æ»¤ã€Jinja å®ç­‰åº•å±‚èƒ½åŠ›è¡¥é½ï¼›é…åˆç°æœ‰çš„ Line/Area/Bar å›¾ä¸é«˜çº§åˆ†æï¼Œå¯è¦†ç›–ä» KPI å¡ç‰‡åˆ°å¤šç»´è¶‹åŠ¿ã€ç¯æ¯”åŒæ¯”ã€æ»šåŠ¨å¹³å‡ä¹ƒè‡³ç½®ä¿¡åŒºé—´çš„æ•´å¥—éœ€æ±‚ã€‚æŒæ¡ä¸Šè¿°æ­¥éª¤ï¼Œå°±èƒ½åœ¨å‡ åˆ†é’Ÿå†…æ­å»ºå‡ºä¸“ä¸šçš„æ—¶åºåˆ†æä»ªè¡¨ç›˜ã€‚

[1]: https://preset.io/blog/apache-superset-4-1-release-notes/ "Apache Superset 4.1 Release Notes | Preset"
[2]: https://fossies.org/linux/apache-superset/RELEASING/release-notes-4-1/README.md "Superset: RELEASING/release-notes-4-1/README.md | Fossies"
[3]: https://fossies.org/linux/apache-superset/CHANGELOG/4.1.0.md "Superset: CHANGELOG/4.1.0.md | Fossies"
[4]: https://github.com/apache/superset/discussions/31426 "Big Number with Time Period Comparison Chart Â· apache superset Â· Discussion #31426 Â· GitHub"
[5]: https://preset.io/blog/2020-06-26-timeseries-chart/ "How to Use a Time Series Chart - Getting Started | Preset"
[6]: https://docs.preset.io/docs/big-number-chart "Big Number Chart in Preset"
[7]: https://github.com/apache/superset/discussions/19145 "Add confidence interval capability to time series line charts Â· apache superset Â· Discussion #19145 Â· GitHub"



### 3.å›¾è¡¨ - æ—¶é—´åºåˆ—é…ç½®ä½¿ç”¨è¯´æ˜

![image.png](https://chengdu-obsidian-milkkey.oss-cn-chengdu.aliyuncs.com/img/20250514132841407.png?cd-oss-obs)


ä¸‹é¢è¿™å‡ ä¸ªè¾“å…¥æ¡†åˆ†åˆ«æ§åˆ¶ä»€ä¹ˆã€åº”è¯¥æ€ä¹ˆå¡«ï¼Œå–å†³äº**ä½ æ‰“ç®—åœ¨è¿™åˆ—é‡Œå±•ç¤ºã€Œæµæ°´ã€çš„å“ªç§å¯¹æ¯”æ–¹å¼**ã€‚å…ˆæŠŠå«ä¹‰å¿«é€Ÿè¯´æ¸…æ¥šï¼Œå†ç»™ä¸¤ä¸ªå¸¸è§åœºæ™¯çš„â€œå¯ç›´æ¥ç…§æŠ„â€ç¤ºä¾‹ã€‚

| æ§ä»¶                            | ä½œç”¨                                                                                                                                                                                                    | å¸¸è§å¡«æ³•                                                              |
| ----------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------- |
| **ç±»å‹ï¼ˆä¸Šé¢çš„ä¸‹æ‹‰ï¼‰**                 | é€‰ â€œæ—¶é—´æ¯”è¾ƒâ€ï¼ˆTime comparisonï¼‰åï¼ŒSuperset æ‰ä¼šç»™è¿™åˆ—åšå¯¹æ¯”è¿ç®—ã€‚                                                                                                                                                       | è¯·é€‰æ‹© **æ—¶é—´æ¯”è¾ƒ**                                                      |
| **Time lag**                  | è¦â€œå‘å‰/å‘åâ€åç§»å¤šå°‘ä¸ª *Time grain*ï¼ˆæ—¶é—´ç²’åº¦ï¼‰å†åšå¯¹æ¯”ã€‚å€¼æ˜¯æ•´æ•°ï¼š<br>  â€¢ 1 = ä¸Šä¸€ç²’åº¦<br>  â€¢ 7 = å‰ä¸ƒå¤©ï¼ˆå½“ç²’åº¦=dayï¼‰<br>  â€¢ 12 = å»å¹´åŒæœˆï¼ˆå½“ç²’åº¦=monthï¼‰<br>å¦‚æœä½ å·²ç»åœ¨ *Time Comparison* é‡Œå†™äº† â€œ1 year agoâ€â€œprevious periodâ€ç­‰ **æŸ¥è¯¢çº§åˆ«** çš„æ—¶é—´ä½ç§»ï¼Œè¿™é‡Œå°±ä¿æŒ 0ã€‚ | 0 æˆ– 1 / 7 / 12 / 365 ç­‰                                            |
| **ç±»å‹ï¼ˆä¸‹æ–¹ä¸‹æ‹‰ï¼ŒCalculation typeï¼‰** | é€‰æ‹©è¦æ˜¾ç¤ºçš„è®¡ç®—ç»“æœï¼š<br>  â€¢ **Actual values** (ä¹Ÿå« Value) â†’ å»å¹´/ä¸ŠæœŸçš„åŸå€¼<br>  â€¢ **Difference** â†’ ç»å¯¹å·®å€¼ = å½“å‰âˆ’å¯¹æ¯”æœŸ<br>  â€¢ **Percentage change** â†’ ç™¾åˆ†æ¯”å·®å€¼ = (å½“å‰âˆ’å¯¹æ¯”æœŸ)/å¯¹æ¯”æœŸ                                                  | Difference æˆ– Percentage change                                    |
| **Color bounds**              | è®¾ç½®æ­£è´Ÿé˜ˆå€¼ï¼Œè®©å·®å€¼é¢œè‰²æ¸å˜ã€‚ä¸ºç©ºåˆ™ä¸åšé¢œè‰²æ˜ å°„ã€‚                                                                                                                                                                             | ä¾‹ï¼š-0.2 å’Œ 0.2                                                      |
| **æ•°å­—æ ¼å¼åŒ–**                     | è‡ªå®šä¹‰æ•°å€¼æ ¼å¼ã€‚å¸¸ç”¨ï¼š<br>  â€¢ `,.0f` åƒä½åˆ†éš”æ•´æ•°<br>  â€¢ `,.1%` ç™¾åˆ†æ¯”ä¿ç•™ 1 ä½å°æ•°                                                                                                                                            | æ ¹æ®ä¸Šé¢ç±»å‹é€‰ï¼š<br>  Difference â†’ `,.0f`<br>  Percentage change â†’ `,.1%` |

> Superset 4.1 çš„ Table with Time Comparison æ­£æ˜¯ä¾èµ–è¿™ä¸€å¥—é…ç½®æ¥åŒæ—¶ç»™å‡ºâ€œå½“å‰å€¼ / å¯¹æ¯”å€¼ / Î” / %â€å››åˆ—çš„ã€‚([Preset][1])

---

##### åœºæ™¯ 1ï¼šæœ€è¿‘ 30 å¤©æµæ°´ vs **ä¸Šä¸€æ®µ 30 å¤©**ï¼ˆç¯æ¯” % å˜åŒ–ï¼‰

1. **Data â†’ Time range** é€‰ *Last 30 days*
2. **Query â†’ Time Comparison** ä¸‹æ‹‰é‡Œé€‰ *previous period*
3. è¿›å…¥â€œæµæ°´â€åˆ—çš„ **Column Configuration**ï¼š

   * ç±»å‹ï¼ˆä¸Šé¢ï¼‰ï¼šæ—¶é—´æ¯”è¾ƒ
   * **Time lag**ï¼š`0` ï¼ˆå› ä¸ºæŸ¥è¯¢å±‚é¢å·²ç»æŒ‡å®šâ€œä¸Šä¸€æœŸâ€ï¼‰
   * ç±»å‹ï¼ˆä¸‹é¢ï¼‰ï¼š`Percentage change`
   * æ•°å­—æ ¼å¼åŒ–ï¼š`,.1%`
   * å¦‚éœ€é…è‰²ï¼ŒColor bounds å¯å¡« -0.2 åˆ° 0.2

æ•ˆæœï¼šè¡¨æ ¼ä¼šå‡ºç°å››åˆ—â€”â€”`æµæ°´`ï¼ˆå½“å‰å€¼ï¼‰ã€`æµæ°´_previous`ï¼ˆä¸Šä¸€æ®µå€¼ï¼‰ã€`Î”`ã€`%`ï¼Œæœ€åä¸€åˆ—å°±æ˜¯ç¯æ¯”ç™¾åˆ†æ¯”ã€‚è®¡ç®—é€»è¾‘æ¥è‡ª Superset çš„â€œPercentage Changeâ€ç®—æ³•ã€‚([Preset æ–‡æ¡£][2])

---

##### åœºæ™¯ 2ï¼šæ¯æ—¥æµæ°´ vs **å‰ä¸€æ—¥**ï¼ˆç»å¯¹å·®å€¼ï¼‰

1. **Time grain** è®¾ä¸º `day`ï¼Œ**Time range** é€‰ä½ å…³å¿ƒçš„æ—¥æœŸæ®µã€‚
2. *Query â†’ Time Comparison* **ä¸å¡«**ï¼ˆç•™ç©ºï¼‰ã€‚
3. åœ¨â€œæµæ°´â€åˆ—é…ç½®é‡Œï¼š

   * ç±»å‹ï¼ˆä¸Šé¢ï¼‰ï¼šæ—¶é—´æ¯”è¾ƒ
   * **Time lag**ï¼š`1`ï¼ˆå¾€å‰ 1 å¤©ï¼‰
   * ç±»å‹ï¼ˆä¸‹é¢ï¼‰ï¼š`Difference`
   * æ•°å­—æ ¼å¼åŒ–ï¼š`,.0f`

å½“ç²’åº¦æ˜¯å¤©ï¼ŒTime lag = 1 å°±æ˜¯â€œæ˜¨å¤©â€ã€‚å·®å€¼åˆ—èƒ½ç›´è§‚åæ˜ ä»Šæ—¥æµæ°´æ¯”æ˜¨å¤©å¤š/å°‘å¤šå°‘ã€‚

---

##### å¸¸è§è¸©å‘ & æç¤º

| ç—‡çŠ¶                 | æ’æŸ¥è¦ç‚¹                                                                                          |
| ------------------ | --------------------------------------------------------------------------------------------- |
| Î” å’Œ % éƒ½æ˜¯ 0         | å¯¹æ¯”æœŸæ²¡æœ‰æ•°æ®ï¼›æˆ– Time range æ²¡æœ‰è¦†ç›–åˆ°ä½ï¼›æˆ– Time lag / Time Comparison å†™é”™å¯¼è‡´å®é™…æ¯”è¾ƒçš„æ˜¯åŒä¸€è¡Œ                        |
| åˆ—æ²¡å‡ºæ¥               | ç¡®è®¤ **ç±»å‹** å·²æ”¹æˆâ€œæ—¶é—´æ¯”è¾ƒâ€ï¼Œå¦åˆ™ Superset åªå±•ç¤ºåŸå§‹æ•°å­—                                                       |
| ç™¾åˆ†æ¯”æ˜¾ç¤ºæˆ 0.25 è€Œé 25% | æ•°å­—æ ¼å¼åŒ–æ²¡å¡« `,.1%`ï¼ˆæˆ–è€…é€‰æ‹©äº† Differenceï¼‰                                                              |
| æƒ³å¯¹æ¯”å»å¹´åŒæœˆ            | Time grain = monthï¼ŒTime lag = 12ï¼›æˆ–åœ¨ Query â†’ Time Comparison é‡Œç›´æ¥å†™ â€œ1 year agoâ€ï¼Œç„¶å Time lag = 0 |

ç”¨å¥½è¿™å‡ ä¸ªå­—æ®µï¼Œä½ å°±èƒ½æŠŠ **Table with Time Comparison** æˆ– **Big Number with Time Period Comparison** è¿™äº› 4.1 æ–°å¢å›¾è¡¨çš„å¯¹æ¯”èƒ½åŠ›å‘æŒ¥åˆ°æè‡´ã€‚

[1]: https://preset.io/blog/apache-superset-4-1-release-notes/ "Apache Superset 4.1 Release Notes | Preset"
[2]: https://docs.preset.io/docs/time-comparison "Time Comparison Advanced Feature in Preset"







![image.png](https://chengdu-obsidian-milkkey.oss-cn-chengdu.aliyuncs.com/img/20250514132956945.png?cd-oss-obs)

**ã€Œå‘¨æœŸå¹³å‡å€¼ (Period average)ã€æ˜¯ä»€ä¹ˆï¼Ÿ**
åœ¨ *Table with Time Comparison* / *Time-series Table* é‡Œï¼ŒæŠŠæŸä¸€åˆ—çš„ **ç±»å‹** è®¾æˆ â€œå‘¨æœŸå¹³å‡å€¼â€ åï¼ŒSuperset ä¼šåœ¨\*\*åç«¯ï¼ˆPandas Post-processingï¼‰\*\*ä¸­ä¸ºä½ åšä¸€æ¬¡ **æ»šåŠ¨å¹³å‡ï¼ˆrolling meanï¼‰**ï¼š

> ä»¥å½“å‰è¡Œä¸ºç»“æŸç‚¹ï¼Œå‘å‰æ‹¿ *N* ä¸ªæ—¶é—´ç²’åº¦ï¼ˆPeriodsï¼‰é‡Œçš„åº¦é‡å€¼ï¼Œæ±‚å¹³å‡å¹¶ä½œä¸ºè¿™ä¸€è¡Œçš„æ˜¾ç¤ºç»“æœã€‚
> è¿™æ ·å¯ä»¥æŠŠæ—¥åº¦ã€å‘¨åº¦ç­‰é«˜æ³¢åŠ¨çš„åºåˆ—å¿«é€Ÿå¹³æ»‘æˆ 7 æ—¥å‡çº¿ã€30 æ—¥å‡çº¿ã€12 æœˆå‡çº¿ç­‰ã€‚([è…¾è®¯äº‘][1])

---

#### æ“ä½œé¢æ¿æ¯ä¸ªå­—æ®µçš„å«ä¹‰

| æ§ä»¶               | ä½œç”¨                                                                                                                                                      | å…¸å‹å¡«æ³•                |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| **ç±»å‹**           | é€‰ â€œå‘¨æœŸå¹³å‡å€¼â€ åæ‰ä¼šå‡ºç°ä¸‹é¢ä¸¤ä¸ªè¾“å…¥æ¡† *Periods* / *Min periods*                                                                                                        | â€”                   |
| **Periods**      | **çª—å£é•¿åº¦**ï¼šæ»šåŠ¨å¹³å‡è¦å›çœ‹å¤šå°‘ä¸ªæ—¶é—´ç²’åº¦<br>â€¢ `7` = 7 å¤©ï¼ˆå½“ Time grain=dayï¼‰<br>â€¢ `12` = 12 æœˆï¼ˆå½“ Time grain=monthï¼‰<br>å¿…é¡»æ˜¯æ­£æ•´æ•°ï¼Œå¦åˆ™æŠ¥ â€œPeriods must be a whole numberâ€([é‚®ä»¶å½’æ¡£][2]) | 7 / 30 / 12 â€¦       |
| **Min periods**  | **æœ€å°å¯ç”¨æœŸæ•°**ï¼šçª—å£é‡Œè‡³å°‘è¦æœ‰å¤šå°‘ä¸ªç‚¹æ‰æ˜¾ç¤ºå€¼ã€‚<br>å¦‚æœä¹Ÿå¡« `7`ï¼Œå°±èƒ½æŠŠå‰ 6 å¤©çš„â€œé¢„çƒ­æœŸâ€éšè—æ‰ï¼Œé¿å…å¼€å¤´é‚£æ®µé€æ¸çˆ¬å‡çš„å‡è±¡ã€‚                                                                                | é€šå¸¸å’Œ *Periods* å†™åŒä¸€ä¸ªæ•° |
| **Time lag**     | ï¼ˆå¯é€‰ï¼‰çª—å£æ•´ä½“å†å‘å‰/å‘ååç§»å¤šå°‘ä¸ªç²’åº¦ã€‚<br>â€¢ `0` = ä»¥å½“å‰è¡Œç»“å°¾<br>â€¢ `1` = åªçœ‹å½“å‰è¡Œä¹‹å‰çš„å®Œæ•´ N æœŸå¹³å‡ï¼ˆæ’é™¤å½“æ—¥ï¼‰                                                                              | 0 æˆ– 1               |
| **Color bounds** | ç»™æ»šåŠ¨å¹³å‡åšåŒºé—´ç€è‰²ï¼›ç•™ç©ºè¡¨ç¤ºä¸é…è‰²                                                                                                                                      | ä¾‹ï¼š0ï½500             |
| **æ•°å­—æ ¼å¼åŒ–**        | d3 æ ¼å¼ä¸²ã€‚å‡çº¿é€šå¸¸ä¿ç•™ 1â€“2 ä½å°æ•°æˆ–ç”¨åƒåˆ†ä½ï¼š<br>`,.1f` / `,.2f`                                                                                                          | æ ¹æ®éœ€æ±‚                |

> âš ï¸ åœ¨é€‰æ‹© â€œå‘¨æœŸå¹³å‡å€¼â€ åï¼Œåªæœ‰ *Periods* å¡«äº†åˆæ³•æ•°å­—ã€å¹¶ä¸”æ•´ä½“æŸ¥è¯¢ç»“æœ â‰¥ Periods è¡Œï¼ŒSuperset æ‰ä¼šæŠŠè¿™ä¸ªåˆ—æ¸²æŸ“å‡ºæ¥ã€‚

---

#### ä¸¤ä¸ªâ€œç…§æŠ„å³å¯â€çš„ç¤ºä¾‹

##### 1ï¸âƒ£ æ˜¾ç¤º**7 æ—¥æ»šåŠ¨å‡çº¿**ï¼ˆå«å½“å¤©ï¼‰

| ä½ç½®                | è®¾ç½®             |
| ----------------- | -------------- |
| **Time grain**    | `day`          |
| **Time range**    | `Last 60 days` |
| **åˆ—ç±»å‹**           | å‘¨æœŸå¹³å‡å€¼          |
| **Periods**       | `7`            |
| **Min periods**   | `7`            |
| **Time lag**      | `0`            |
| **Number format** | `,.0f`         |

> è¡¨æ ¼ä¼šåœ¨åº¦é‡åˆ—å³ä¾§ç”Ÿæˆä¸€åˆ— â€œxxxx\_rolling\_avg\_7dâ€ï¼Œå…¶æ•°å€¼ç­‰äºå½“å¤©åŠå¾€å‰ 6 å¤©çš„å¹³å‡ã€‚

---

##### 2ï¸âƒ£ æ˜¾ç¤º**æœˆåº¦ 3 æœŸå‡çº¿**ï¼ˆæ’é™¤å½“æœˆï¼Œè§‚å¯Ÿè½å 1 æœŸï¼‰

| ä½ç½®                | è®¾ç½®               |
| ----------------- | ---------------- |
| **Time grain**    | `month`          |
| **Time range**    | `Last 24 months` |
| **Periods**       | `3`              |
| **Min periods**   | `3`              |
| **Time lag**      | `1`              |
| **Number format** | `,.1f`           |

> ç»“æœåˆ—æ˜¯ã€Œä¸Šæœˆ + å†å¾€å‰ä¸¤ä¸ªæœˆã€çš„ 3 ä¸ªæœˆå¹³å‡ï¼Œç”¨æ¥å¯¹æ¯”å½“æœˆå®é™…å€¼æ—¶å°±æ²¡æœ‰â€œæŠŠå½“æœˆè‡ªå·±ä¹Ÿç®—è¿›å»â€çš„åå·®ã€‚

---

#### å¸¸è§é—®é¢˜ & è°ƒä¼˜

| ç°è±¡            | è¯Šæ–­ & è§£å†³                                                                            |
| ------------- | ---------------------------------------------------------------------------------- |
| åˆ—ä¸æ˜¾ç¤º / å…¨æ˜¯ NaN | *Periods* å¡«äº† 0 æˆ–éæ•´æ•°ï¼›æˆ– Time range è¡Œæ•° < *Periods*ï¼›æˆ–æŸç»´åº¦åœ¨çª—å£å†…å…¨ NULLã€‚                    |
| å‰å‡ è¡Œæ–œç€å¾€ä¸Šçˆ¬      | å…¸å‹â€œé¢„çƒ­æœŸâ€â€”â€”æŠŠ **Min periods** å¡«æˆå’Œ *Periods* ç›¸åŒå³å¯éšè—ã€‚                                   |
| æƒ³è®©å‡çº¿å’ŒåŸå€¼éƒ½å‡ºç°    | åœ¨ **Time series columns** é‡ŒåŠ ä¸¤è¡Œï¼šä¸€è¡Œé€‰ *Actual Value*ï¼Œä¸€è¡Œé€‰ *Period average*ï¼Œéƒ½æŒ‡å‘åŒä¸€ä¸ªåº¦é‡å°±è¡Œã€‚ |
| è¡¨å¤ªå¤§è·‘ä¸åŠ¨        | å‡çº¿æ˜¯åœ¨ Superset åç«¯æ»šåŠ¨è®¡ç®—çš„ï¼Œå¯¹è¶…å¤§ç»“æœé›†å¼€é”€è¾ƒé«˜ã€‚å¯å…ˆåœ¨ **Query â†’ Row limit** æ§åˆ¶è¡Œæ•°ï¼Œæˆ–æŠŠ Time grain è°ƒç²—ã€‚  |

---

#### ä¸€å¥è¯æ€»ç»“

> **å‘¨æœŸå¹³å‡å€¼ = æ»šåŠ¨å‡çº¿ã€‚** é€‰å¥½çª—å£é•¿åº¦ (*Periods*)ã€æœ€å°æœŸæ•° (*Min periods*)ï¼Œå†å†³å®šæ˜¯å¦æ’é™¤å½“å‰è¡Œ (*Time lag*)ï¼Œå°±èƒ½æŠŠåŸå§‹æŒ‡æ ‡å¹³æ»‘æˆæ—¥å‡ / å‘¨å‡ / æœˆå‡ï¼Œç”¨äºè¶‹åŠ¿æ´å¯Ÿæˆ– KPI å¯¹æ¯”ï¼Œæ— éœ€åœ¨ SQL é‡Œæ‰‹åŠ¨å†™çª—å£å‡½æ•°ã€‚

[1]: https://cloud.tencent.com/developer/article/1876864 "ï¼ˆäºŒï¼‰Superset 1.3å›¾è¡¨ç¯‡â€”â€”Time-series Table-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘"
[2]: https://www.mail-archive.com/commits%40superset.incubator.apache.org/msg01950.html?utm_source=chatgpt.com "[incubator-superset] branch master updated: Fix bug: some word not ..."



#### sparklineåˆæ˜¯ä»€ä¹ˆæ„æ€ï¼Œå¦‚ä½•ä½¿ç”¨å‘¢

##### 1. ä»€ä¹ˆæ˜¯ **Sparkline** ?

> **Sparkline = è¿·ä½ è¶‹åŠ¿çº¿**
> å®ƒæ˜¯ä¸€æ¡åªæœ‰å‡ åä¸ªåƒç´ é«˜çš„å°æŠ˜çº¿/å°æŸ±çŠ¶ï¼Œè¢«ç›´æ¥æ¸²æŸ“åœ¨è¡¨æ ¼å•å…ƒæ ¼é‡Œï¼Œç”¨æ¥â€œä¸€çœ¼â€å‘ˆç°è¯¥è¡ŒæŒ‡æ ‡åœ¨ä¸€æ®µæ—¶é—´å†…çš„èµ°åŠ¿ï¼Œè€Œä¸ç”¨å†åˆ‡æ¢åˆ°å•ç‹¬çš„å¤§å›¾ã€‚
> åœ¨ Superset 4.x é‡Œï¼ŒSparkline åªèƒ½å‡ºç°åœ¨ **Time-series Table** / **Table with Time Comparison** è¿™ä¸¤ç§è¡¨æ ¼å‹å›¾è¡¨çš„åˆ—ä¸Šã€‚

å¸¸è§ç”¨é€” âœ…

| ä¸šåŠ¡åœºæ™¯           | è§£è¯»ç¤ºä¾‹                           |
| -------------- | ------------------------------ |
| æ¯ä¸ªä¸»æ’­è¿‘ 30 å¤©æ”¶å…¥è¶‹åŠ¿ | ä¸€è¡Œä¸€ä¸ªä¸»æ’­ï¼Œå³ä¾§ Sparkline é«˜ä½èµ·ä¼æ˜¾ç¤ºæ”¶å…¥æ³¢åŠ¨ |
| æ¯ä¸ªæ¸ é“æ¯æ—¥ DAU èµ°åŠ¿  | è¡Œå¤´æ˜¯æ¸ é“åï¼ŒSparkline ä¸€çœ¼çœ‹å‡ºå“ªæ¡å¢é•¿ã€å“ªæ¡ä¸‹æ»‘ |
| KPI çœ‹æ¿ä¸­çš„â€œä½“æ¸©è®¡â€åˆ— | æŠŠç»å¯¹å€¼éšè—ï¼Œåªç”¨çº¿æ¡é•¿çŸ­é«˜ä½æç¤ºè¶‹åŠ¿            |

---

##### 2. å¦‚ä½•é…ç½® Sparklineï¼ˆ5 æ­¥èµ°ï¼‰

> **å‰æ**ï¼šä½ å·²ç»é€‰å¥½ **Time-series Table**ï¼ˆæˆ– *Table with Time Comparison*ï¼‰å¹¶è®©æŸ¥è¯¢è‡³å°‘è¿”å›ã€æ—¶é—´åˆ— + æŒ‡æ ‡åˆ—ã€‘ã€‚

| æ­¥éª¤                            | æ“ä½œ                                                                                                                      | å…³é”®ç‚¹                              |
| ----------------------------- | ----------------------------------------------------------------------------------------------------------------------- | -------------------------------- |
| **â‘  è®¾æ—¶é—´èŒƒå›´ & ç²’åº¦**              | *Time* é¢æ¿ â†’ Time range: *Last 30 days*ï¼ˆä¸¾ä¾‹ï¼‰<br>Time grain: *day*                                                         | Sparkline çš„ X è½´å°±æ˜¯è¿™é‡Œç¡®å®šçš„ 30 ä¸ªâ€œæ—¶é—´æ¡¶â€ |
| **â‘¡ é€‰åˆ†ç»„å­—æ®µ**                   | *Query* é¢æ¿ â†’ Group by é‡Œæ”¾ â€œguild\_nameâ€ æˆ–ä»»ä½•ç»´åº¦                                                                            | æ¯ä¸ªç»´åº¦å€¼ä¼šå è¡¨æ ¼ä¸€è¡Œ                      |
| **â‘¢ æ·»åŠ ç¬¬äºŒåˆ—æŒ‡æ ‡**                 | åœ¨ *Metrics* â†’ *Time series columns* æŠŠåŒä¸€æŒ‡æ ‡ **å†æ‹–ä¸€æ¬¡**ï¼Œè®©è¡¨æ ¼é‡Œå‡ºç°ä¸¤ä¸ªåŒååº¦é‡                                                         | ç¬¬ä¸€ä¸ªä¿ç•™æ•°å€¼ï¼Œç¬¬äºŒä¸ªç”¨äºç”»çº¿                  |
| **â‘£ æ‰“å¼€ Column Configuration** | å¯¹ç¬¬äºŒä¸ªåº¦é‡ç‚¹å‡» âœï¸                                                                                                             |                                  |
| **â‘¤ è°ƒæ•´ä¸‰é¡¹è®¾ç½®**                  | - **ç±»å‹(Type)** â†’ `Sparkline`<br>- **Periods** â†’ *ç•™ç©º*ï¼ˆ= ç”¨æŸ¥è¯¢è¿”å›çš„æ‰€æœ‰ç‚¹ï¼‰æˆ–å¡« `7` å–æœ€è¿‘ 7 å¤©<br>- **Number format** â†’ `,.0f`ï¼ˆæˆ–ä¸æ˜¾ç¤ºæ•°å€¼ï¼‰ | è¿™æ—¶è¡¨æ ¼é¢„è§ˆå°±ä¼šæŠŠè¯¥åˆ—æ¸²æŸ“ä¸ºç»†å°æŠ˜çº¿ / å°æŸ±          |

> **ä¿å­˜** å¹¶ **Run**ï¼ŒDashboard ä¸­å°±èƒ½çœ‹åˆ°æ¯è¡Œå³ä¾§è·Ÿç€ä¸€æ¡â€œå°å¿ƒç”µå›¾â€å¼çš„è¶‹åŠ¿çº¿ã€‚

---

##### 3. è¿›é˜¶å¯è°ƒé€‰é¡¹

| é…ç½®é¡¹                                | ä½œç”¨                   | å»ºè®®å€¼                       |
| ---------------------------------- | -------------------- | ------------------------- |
| **Sparkline type**<br>(Line / Bar) | æŠ˜çº¿æˆ–æŸ±çŠ¶                | æŠ˜çº¿æ›´ç›´è§‚ï¼ŒæŸ±çŠ¶é€‚åˆç¦»æ•£æ•°æ®            |
| **Rolling window**                 | å¯¹ Sparkline æ•°æ®å†åšæ»šåŠ¨å¹³å‡ | æ—¥æ•°æ®å¸¸å¡« `7` æŠŠé«˜é¢‘å™ªå£°å¹³æ»‘         |
| **Width / Height**                 | å•å…ƒæ ¼ä¸­çº¿æ¡çš„å®½é«˜åƒç´           | é»˜è®¤å³å¯ï¼›è¡¨æ ¼å¤ªçª„æ—¶å¯å‡å°             |
| **Color bounds**                   | ç»™ Sparkline çº¿å¡«å……æ¸å˜è‰²   | ä¸šåŠ¡å¸¸ç•™ç©ºï¼›è¦å¼ºè°ƒé«˜ä½å¯å¡« 0, 500 è¿™ç±»é˜ˆå€¼ |
| **Show tooltip**                   | æ‚¬åœæ˜¾ç¤ºå…·ä½“å€¼              | é»˜è®¤å¼€å¯å³å¯                    |
|                                    |                      |                           |

*ä¸åŒ Superset ç‰ˆæœ¬/ä¸»é¢˜ï¼Œé€‰é¡¹åå­—å¯èƒ½ç•¥æœ‰å·®å¼‚ï¼Œä½†éƒ½åœ¨ã€ŒColumn Configuration â†’ Sparklineã€å—é‡Œã€‚*

---

##### 4. ä½¿ç”¨å°è´´å£« & å¸¸è§é—®é¢˜

| é—®é¢˜ / ç›®æ ‡              | è§£å†³æ–¹æ¡ˆ                                                                                                                                                     |
| -------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **åªæƒ³çœ‹æœ€å 7 å¤©èµ°åŠ¿**      | åœ¨ Column Configuration é‡ŒæŠŠ **Periods** å¡« `7`                                                                                                              |
| **è¡¨æ ¼å¡é¡¿**ï¼ˆè¡Œæ•° Ã— æ—¶é—´ç‚¹å¤ªå¤šï¼‰ | - Row limit æ§åˆ¶è¡Œï¼Œæˆ–æŠŠ Time grain è°ƒç²—ï¼ˆdayâ†’weekï¼‰                                                                                                               |
| **æƒ³åŒæ—¶æ˜¾ç¤ºæ•°å€¼+çº¿**        | *Column A* ä¿ç•™æ•°å€¼ï¼Œ*Column A (copy)* è®¾ Sparkline                                                                                                            |
| **Sparkline é¢œè‰²å¤ªæµ…**   | åœ¨ Dashboard -> Color scheme é€‰æ‹©æ·±è‰²è°ƒï¼Œæˆ–åœ¨åˆ—é…ç½®é‡Œæ”¹çº¿/æŸ±é¢œè‰²                                                                                                           |
| **è¦åšåŒæ¯”/ç¯æ¯”+è¶‹åŠ¿çº¿**      | ç”¨ *Table with Time Comparison*ï¼š<br>1ï¸âƒ£ Metrics åˆ— Ã—2 (åŸå€¼ + Sparkline)<br>2ï¸âƒ£ Query â†’ Time comparison å†™ `1 year ago`<br>3ï¸âƒ£ Sparkline é‚£åˆ— Time lag è®¾ `0` å³å¯ |

---

##### 5. ä¸€å¥è¯æ€»ç»“

> **Sparkline = æŠŠæ—¶é—´åºåˆ—è¿·ä½ åŒ–æ”¾è¿›è¡¨æ ¼å•å…ƒæ ¼**ã€‚
> åœ¨ Time-series Table ä¸­å¤åˆ¶å‡ºä¸€åˆ—æŒ‡æ ‡ â†’ Column Configuration é‡ŒæŠŠ **ç±»å‹**é€‰ä¸º *Sparkline*ï¼Œå†æŒ‰éœ€è®¾ Periods / é¢œè‰² / æ»šåŠ¨çª—å£ï¼Œå°±èƒ½è®©æ¯è¡Œç»´åº¦å¸¦ç€è‡ªå·±çš„â€œå°è¶‹åŠ¿â€ï¼Œè®©ä½ çš„ Superset 4.1 ä»ªè¡¨ç›˜æ—¢èŠ‚çœç©ºé—´åˆä¿¡æ¯ä¸°å¯Œã€‚



### Time lag åœ¨ Superset é‡Œçš„ 3 ç§å…¸å‹â€œè®¾æ³•â€


#### Time lag åœ¨ Superset é‡Œçš„ 3 ç§å…¸å‹â€œè®¾æ³•â€

| åœºæ™¯                                                                                             | **åœ¨å“ªå„¿è®¾ç½®**                                                                                  | å¯ä»¥å¡«ä»€ä¹ˆ                              | å¸¸è§ç”¨é€”                                        |
| ---------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ | ---------------------------------- | ------------------------------------------- |
| **â‘  åˆ—çº§ Time lag**<br>(Table with Time Comparison / Time-series Table â†’ *Column Configuration*) | å¯¹åº”åº¦é‡é‚£ä¸€è¡Œçš„ **Time lag** è¾“å…¥æ¡†                                                                  | çº¯æ•´æ•° â‰¥ 0<br>0 = æœ¬æœŸ<br>1 = ä¸Šä¸€ç²’åº¦<br>â€¦ | ç»™å•ä¸ªåº¦é‡åš *n* æœŸå¯¹æ¯”<br>ï¼ˆæ˜¨å¤©ã€ä¸Šå‘¨ã€å»å¹´åŒæœˆâ€¦ï¼‰             |
| **â‘¡ æŸ¥è¯¢çº§ Time Comparison**<br>(Charts â†’ *Query* é¢æ¿ â†’ **Time Comparison**)                       | è‡ªç„¶è¯­è¨€æ—¶é—´åç§»ä¸²ï¼š<br>â€†`1 day ago` `4 weeks ago`<br>â€†`previous period`<br>â€†`2 years ago` â€¦         | ä¸€æ¬¡å¯¹æ•´å¼ å›¾/è¡¨åŠ  1\~10 æ¡å¯¹æ¯”çº¿æˆ–å¯¹æ¯”åˆ—           | KPI å¡ç‰‡/æŠ˜çº¿è¶‹åŠ¿ä¸€æ¬¡çœ‹å¤šæ¡â€œå¯¹é½â€åºåˆ—([docs.preset.io][1]) |
| **â‘¢ SQL / Jinja çº§ä½ç§»**<br>(è‡ªå†™ SQLã€Jinja å®)                                                      | `WHERE {{ get_time_filter('ts') }}`<br>`SELECT date_trunc('day', ts) - INTERVAL '7 day'` â€¦ | é«˜çº§å®šåˆ¶ï¼šé”™ä½ JOINã€åŒç¯æ¯”+æ»‘çª—                | å¤æ‚æŠ¥è¡¨æˆ–éœ€è¦å¤šåˆ—ä¸åŒä½ç§»æ—¶                              |

---

##### 1ï¸âƒ£ åˆ—çº§ **Time lag** â€”â€”â€œå‘å‰ *n* æ ¼â€

> *æ‰€åœ¨ä½ç½®ï¼šTable with Time Comparison â†’ åº¦é‡åˆ— â†’ Column Configurationã€‚*

* **æ•°å€¼ = å›çœ‹å‡ ä¸ª *Time grain***

  * `Time grain = day` â†’ **1** = æ˜¨å¤©ï¼Œ**7** = ä¸Šå‘¨åŒæ—¥
  * `Time grain = month` â†’ **12** = å»å¹´åŒæœˆ
  * `Time grain = quarter` â†’ **4** = å»å¹´åŒå­£
* **0 è¡¨ç¤º** â€œå’Œæœ¬æœŸå¯¹æ¯”â€â€”â€”é€šå¸¸ä¸ **Queryâ†’Time Comparison** åˆç”¨ï¼Œå…ˆåœ¨æŸ¥è¯¢å±‚åš 1 year agoï¼Œç„¶ååˆ—é‡Œ Time lag è®¾ 0ï¼Œä»…ç”¨æ¥æŒ‘é€‰â€œç»å¯¹å·®å€¼ / ç™¾åˆ†æ¯”å·®å€¼â€ç­‰è®¡ç®—ç±»å‹ã€‚
* **ä¸å¯å†™è´Ÿæ•°**ï¼ˆæƒ³çœ‹æœªæ¥è¯·åˆ°æŸ¥è¯¢å±‚ç”¨ `1 day later` è¿™ç±»è¯­æ³•ï¼‰ã€‚

> **ç¤ºä¾‹ï¼š**
>
> * ã€Œæ—¥ç²’åº¦ï¼Œæƒ³çœ‹æ—¥ç¯æ¯”å·®å€¼ã€â†’ Time lag = **1**ï¼ŒCalculation type é€‰ *Difference*
> * ã€Œæœˆç²’åº¦ï¼Œæƒ³çœ‹å»å¹´åŒæœˆåŒæ¯”%ã€â†’ Time lag = **12**ï¼ŒCalculation type é€‰ *Percentage change*ï¼ŒNumber format `,.1%`

---

##### 2ï¸âƒ£ æŸ¥è¯¢çº§ **Time Comparison / Time Shift** â€”â€”â€œä¸€æ¬¡æ€§å¤šæ¡å¯¹æ¯”â€

*åœ¨æ‰€æœ‰æ—¶é—´åºåˆ—å›¾è¡¨çš„ **Query** é¢æ¿éƒ½èƒ½çœ‹åˆ°ã€‚*

* ç›´æ¥å†™åç§»ä¸²ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼š
  `1 week ago` / `4 weeks ago` / `1 year ago` / `previous period` â€¦
* Superset ä¼šå¸®ä½ ç”Ÿæˆå¤šæ¡åºåˆ—æˆ–å¤šåˆ—ï¼ˆActual / Î” / %ï¼‰ã€‚
* ä½ ä»å¯åœ¨åˆ—çº§ **Time lag=0** æ¥å†³å®šæ˜¾ç¤ºå“ªç§è®¡ç®—åˆ—ï¼ˆå·®å€¼ã€æ¯”ä¾‹ç­‰ï¼‰ã€‚

ğŸ“Œ **æ³¨æ„**ï¼šTime Comparison éœ€è¦ä¸€ä¸ªâ€œå°é—­çš„æ—¶é—´èŒƒå›´â€ï¼Œå¦åˆ™ Superset ä¼šæŠ¥é”™ âAn enclosed time range must be specifiedâã€‚([docs.preset.io][1])

---

##### 3ï¸âƒ£ SQL / Jinja çº§ä½ç§» â€”â€”â€œæˆ‘å…¨éƒ½è¦â€

å½“ä¸€ä¸ªæŠ¥è¡¨é‡Œæ—¢è¦ **æ—¥ç¯æ¯”**ã€åˆè¦ **å‘¨ç¯æ¯”**ï¼Œæˆ–è€…è¦æŠŠã€Œå»å¹´åŒæœˆ + ä¸Šä¸€æœŸ + æ»šåŠ¨å‡çº¿ã€ä¸€æ¬¡å¡è¿›åŒä¸€å¼ è¡¨æ—¶ï¼Œä»…é  UI è¾“å…¥æ¡†ä¼šå¾ˆå±€ä¿ƒï¼Œå¯ä»¥ï¼š

```sql
SELECT
  date,
  revenue,
  LAG(revenue, 1)  OVER (ORDER BY date)          AS rev_d1,
  LAG(revenue, 7)  OVER (ORDER BY date)          AS rev_d7,
  LAG(revenue, 30) OVER (ORDER BY date)          AS rev_d30
FROM sales
WHERE {{ get_time_filter('date') }}
```

ç„¶ååœ¨ **Dataset â†’ Calculated columns** æŠŠ `revenue - rev_d1` / `(revenue - rev_d365)/NULLIF(rev_d365,0)` å†åŒ…è£…æˆåº¦é‡å³å¯ã€‚

---

#### å¿«é€Ÿå¯¹ç…§ï¼š**ç”¨å“ªä¸ª Time lagï¼Ÿ**

| éœ€æ±‚            | å»ºè®®åšæ³•                                                      |
| ------------- | --------------------------------------------------------- |
| å•åˆ—å¯¹æ¯”ã€çª—å£çŸ­      | **åˆ—çº§ Time lag**ï¼ˆæœ€ç›´è§‚ï¼Œå°‘å†™ä¸€æ¬¡æŸ¥è¯¢ï¼‰                               |
| åŒä¸€å›¾/è¡¨ä¸€æ¬¡çœ‹å¤šæ¡å¯¹æ¯”çº¿ | **æŸ¥è¯¢çº§ Time Comparison**ï¼Œå†™å¤šæ¡ `x weeks ago`ï¼›åˆ—çº§ Time lag è®¾ 0 |
| å¤šç§é”™ä½æ··æ‚ã€é€»è¾‘å¤æ‚   | ç›´æ¥ SQL çª—å£å‡½æ•°æˆ– Jinja å®ï¼Œæå®šåä½œä¸ºæ™®é€šåº¦é‡ä½¿ç”¨                          |

---

#### å¸¸è§ç–‘é—®

| é—®é¢˜                                | è§£é‡Š                                                                    |
| --------------------------------- | --------------------------------------------------------------------- |
| **å¯ä»¥å†™è´Ÿæ•°å—ï¼Ÿ**                       | åˆ—çº§ Time lag ç›®å‰åªæ¥å— â‰¥ 0ï¼›è¦çœ‹æœªæ¥ï¼Œæ”¹ç”¨ Queryâ†’Time Comparison å†™ `1 week later`ã€‚ |
| **åˆ—çº§å’ŒæŸ¥è¯¢çº§å†²çªæ€ä¹ˆåŠï¼Ÿ**                  | äºŒè€…ä¼šâ€œå åŠ â€ã€‚é€šå¸¸ **äºŒé€‰ä¸€**ï¼š<br>â€¢ éœ€è¦å¤šå¯¹æ¯”â†’ç”¨æŸ¥è¯¢çº§ï¼›<br>â€¢ åªçœ‹ç¯æ¯”/åŒæ¯”â†’åˆ—çº§ + Time lag =Nã€‚   |
| **Time grain æ”¹äº†è¦åŒæ­¥æ”¹ Time lag å—ï¼Ÿ** | æ˜¯çš„ã€‚ç²’åº¦ä» dayâ†’week ååŸæ¥ `7` å°±ä¸å†ä»£è¡¨ä¸€å‘¨ï¼Œè€Œæ˜¯ 7 å‘¨ã€‚                               |

---

#### ä¸€å¥è¯æ€»ç»“

> **Time lag** å°±æ˜¯â€œå‘å‰é”™ä½ *n* ä¸ªæ—¶é—´ç²’åº¦â€ã€‚
>
> * *åˆ—çº§* Time lagï¼šç»™å•åˆ—åšç¯æ¯”/åŒæ¯”ã€‚
> * *æŸ¥è¯¢çº§* Time Comparisonï¼šä¸€æ¬¡æ‹‰å¤šæ¡å¯¹æ¯”çº¿/åˆ—ã€‚
> * é«˜çº§ç»„åˆï¼šSQL çª—å£å‡½æ•°æˆ– Jinjaã€‚
>   æŠŠè¿™ä¸‰æ‹›çµæ´»å¥—ç”¨ï¼Œä½ çš„ Superset 4.1 æ—¶é—´å¯¹æ¯”åˆ†æå°±èƒ½éšå¿ƒæ‰€æ¬²ã€‚

[1]: https://docs.preset.io/docs/time-comparison "Time Comparison Advanced Feature in Preset"



## 3.è¿‡æ»¤å™¨

å¹¶ä¸æ˜¯ â€œæ²¡æœ‰è¿‡æ»¤å™¨â€â€”â€”**4.1 æŠŠæ—§çš„ Filter Boxï¼Filter Set å…¨éƒ¨ç§»é™¤äº†ï¼Œä½†ä¿ç•™å¹¶å¼ºåŒ–äº†ã€ŒåŸç”Ÿè¿‡æ»¤å™¨ï¼ˆNative Filtersï¼‰ã€ä½“ç³»**ã€‚æ¢å¥è¯è¯´ï¼šè¿‡æ»¤èƒ½åŠ›è¿˜åœ¨ï¼Œåªæ˜¯å…¥å£å’Œäº¤äº’æ–¹å¼å˜äº†ã€‚ä¸‹é¢æŠŠæ ¸å¿ƒå˜åŒ–å’Œå®é™…ç”¨æ³•å¿«é€Ÿè¯´æ˜ä¸€ä¸‹ã€‚

---

#### 1 ä¸ºä»€ä¹ˆä½ ä¼šæ„Ÿè§‰â€œè¿‡æ»¤å™¨ä¸è§äº†â€ï¼Ÿ

| 4.0 ä¹‹å‰                     | 4.0 åŠä»¥å                                           |
| -------------------------- | ------------------------------------------------- |
| **Filter Box** ä»¥å›¾è¡¨å½¢å¼æ’åœ¨ä»ªè¡¨ç›˜é‡Œ | è¢«å½»åº•åˆ é™¤ï¼Œä»£ç ä¹Ÿç§»é™¤ï¼›æ—§ä»ªè¡¨ç›˜ä¼šåœ¨å‡çº§è„šæœ¬é‡Œè‡ªåŠ¨è¿ç§»åˆ°åŸç”Ÿè¿‡æ»¤å™¨é¢æ¿ ([Preset][1]) |
| **Filter Set**ï¼ˆä¾§è¾¹å¤šä¸ªé¢„è®¾ï¼‰     | åŒæ ·åˆ é™¤ï¼Œä¸å†ç»´æŠ¤ ([Preset][1])                           |
| åŸç”Ÿè¿‡æ»¤å™¨ï¼ˆNative Filtersï¼‰      | ç»§ç»­å­˜åœ¨ï¼Œå¹¶æˆä¸º**å”¯ä¸€æ¨èæ–¹å¼**                                |

---

#### 2 ç°åœ¨è¯¥æ€ä¹ˆâ€œåŠ è¿‡æ»¤å™¨â€ï¼Ÿ

1. **æ‰“å¼€ä»ªè¡¨ç›˜ â†’ â€œç¼–è¾‘â€**
2. å³ä¸Šè§’åˆ‡æ¢åˆ° **Filters** æ ‡ç­¾é¡µ
3. ç‚¹å‡» **ï¼‹ Add filter**ï¼ŒæŒ‰å‘å¯¼é€‰ï¼š

   * **æ•°æ®é›†**ï¼ˆDatasetï¼‰
   * **åˆ—**ï¼ˆColumnï¼‰
   * è¿‡æ»¤ç±»å‹ï¼ˆä¸‹æ‹‰ã€å¤šé€‰ã€æ—¶é—´èŒƒå›´ç­‰ï¼‰
4. ï¼ˆå¯é€‰ï¼‰åœ¨ **Scope** é‡Œå‹¾é€‰å“ªäº›å›¾è¡¨è¦å—æ­¤è¿‡æ»¤å™¨å½±å“
5. **Save** å¹¶é€€å‡ºç¼–è¾‘ï¼Œä¾§è¾¹å°±ä¼šå‡ºç°ä¸€ä¸ªå¯æŠ˜å çš„è¿‡æ»¤å™¨é¢æ¿

è¿™å°±æ˜¯æ–°ç‰ˆçš„â€œè¿‡æ»¤æ â€ä½“éªŒï¼ŒPreset å®˜æ–¹æŠŠå®ƒå« **Dashboard Native Filters** ([Restack][2])ã€‚

---

#### 3 ç‰¹æ®Šåœºæ™¯æç¤º

| éœ€æ±‚                     | åšæ³•                                                                            |
| ---------------------- | ----------------------------------------------------------------------------- |
| **æŠŠæ—§ Filter Box è‡ªåŠ¨è¿ç§»** | å‡çº§ 3.xâ†’4.x æ—¶è¿è¡Œè„šæœ¬ï¼š`superset native-filters upgrade`ï¼›æˆ–è€…æ‰‹åŠ¨æ‰§è¡Œ UI æç¤º ([Preset][3]) |
| **è·¨ä»ªè¡¨ç›˜åˆ†äº«è¿‡æ»¤çŠ¶æ€**         | å¤åˆ¶æµè§ˆå™¨åœ°å€ï¼›URL é‡Œä¼šå¸¦ `native_filters=` å‚æ•°ï¼Œå¯ç›´æ¥ç²˜è´´ç»™åŒäº‹ ([Stack Overflow][4])           |
| **æƒ³åœ¨å›¾è¡¨å†…éƒ¨åŠ è¿‡æ»¤æ¡ä»¶**        | è¿›å…¥ Explore é¡µé¢ï¼Œç”¨ **Ad-hoc Filters**ï¼ˆè¿™éƒ¨åˆ†ä¸€ç›´éƒ½åœ¨ï¼‰                                   |
| **æ¡ä»¶å¾ˆå¤æ‚ï¼Œæƒ³è”åŠ¨å¤šåˆ—**        | åŠ å¤šä¸ª Native Filtersï¼Œå¹¶ç”¨ **Filter Scoping** æŒ‡å®šå®ƒä»¬å„è‡ªæ§åˆ¶å“ªäº›å›¾è¡¨                         |

---

#### 4 å’Œæ—§æ–¹æ¡ˆç›¸æ¯”æœ‰å“ªäº›ä¼˜åŠ¿ï¼Ÿ

| æ—§ Filter Box | æ–° Native Filters             |
| ------------ | ---------------------------- |
| åªèƒ½åšä¸‹æ‹‰ã€å¤šé€‰     | æ”¯æŒä¸‹æ‹‰ã€å¤šé€‰ã€æ—¶é—´èŒƒå›´ã€æ»‘å—ã€è‡ªç”±è¾“å…¥         |
| æ— è”åŠ¨          | æ”¯æŒçº§è”ï¼ˆçˆ¶-å­ä¾èµ–ï¼‰ä¸**é»˜è®¤å€¼**          |
| ä½œç”¨åŸŸç²—ç³™        | å¯åœ¨ â€œScopeâ€ ç²¾ç¡®åˆ°å•å¼ å›¾è¡¨           |
| URL å¤ªé•¿ï¼æ˜“å¤±æ•ˆ   | ç”¨ `permalink` + å‹ç¼©å­˜å‚¨ï¼Œé“¾æ¥æ›´çŸ­æ›´ç¨³å®š |
| æ€§èƒ½ç“¶é¢ˆï¼ˆå‰ç«¯å¤§åˆ—è¡¨ï¼‰  | æœåŠ¡ç«¯åˆ†é¡µ + å¼‚æ­¥åŠ è½½                 |

---

#### ä¸€å¥è¯ç»“è®º

> **Superset 4.1 ä¸æ˜¯å–æ¶ˆè¿‡æ»¤å™¨ï¼Œè€Œæ˜¯å…¨é¢è½¬å‘ã€Œä»ªè¡¨ç›˜ä¾§è¾¹åŸç”Ÿè¿‡æ»¤å™¨ã€ï¼›Filter Boxï¼Filter Set å·²é€€å½¹ã€‚**
> åªè¦åœ¨ä»ªè¡¨ç›˜ç¼–è¾‘é¡µé‡Œç”¨ â€œFiltersâ€ é¢æ¿ï¼Œå°±èƒ½æ·»åŠ ã€ç®¡ç†ã€è”åŠ¨æ‰€æœ‰è¿‡æ»¤å™¨åŠŸèƒ½ï¼Œæ•ˆæœæ›´å¼ºä¹Ÿæ›´æ˜“ç”¨ã€‚

[1]: https://preset.io/blog/apache-superset-4-0-release-notes/?utm_source=chatgpt.com "Apache Superset 4.0 Release Notes - Preset"
[2]: https://www.restack.io/docs/superset-knowledge-apache-superset-dashboard-filter?utm_source=chatgpt.com "Add Filter to Apache Superset Dashboard - Restack"
[3]: https://preset.io/blog/superset-3-0-release-notes/?utm_source=chatgpt.com "Superset 3.0 Release Notes - Preset"
[4]: https://stackoverflow.com/questions/76713320/apache-superset-native-filters?utm_source=chatgpt.com "Apache Superset Native Filters - Stack Overflow"

